---
title: "Monet Carlo Integration"
author: "Jinyi Chen"
date: "2020/11/14"
output: pdf_document
---

# Exercise 7.5.1

## (a)

Consider $g(x)$ has the density fucntion 
$$g(x) =\frac{1}{\sqrt{2\pi}} e^{-\frac{x^2}{2}}$$.
```{r}
h <- function(x) {x^2}
df <- function(x) {(x^2 * exp(-((x-2)^2)/2))/(5*sqrt(2*pi))}

g <- function(x) {dnorm(x)}
rg <- function(n) {rnorm(n)}

isAppr <- function(n, h, df, g, rg){
  x <- rg(n)
  mean(h(x) * df(x)/g(x))
}

mysummary <- function(nrep, n, h, df, g, rg){
  sim <- replicate(nrep,isAppr(n, h, df, g, rg))
  c(Expection = mean(sim), Variance = var(sim))
}

mysummary(100,1000, h, df, g, rg)
mysummary(100,10000, h, df, g, rg)
mysummary(100,50000, h, df, g, rg)

```

## (b)

Note that $h(x) = x^2$, a better $g(x)$ can be chosen to be $g(x) \propto x^4 \exp(-\frac{(x-2)^2}{2})$.
One also have $\int_{-\infty}^{+\infty}g(x)\text{d}x=1$, that is 
$$
g(x) = \frac{x^4 \exp(-\frac{(x-2)^2}{2})}
{\int_{-\infty}^{+\infty}x^4 \exp(-\frac{(x-2)^2}{2})\text{d}x} .
$$
Choose $p(x) = $

It is easy to know that 
$$
E^{N(2,1)}(X^4) = {\int_{-\infty}^{+\infty} \frac{x^4}{\sqrt{2\pi}} \exp(-\frac{(x-2)^2}{2})\text{d}x} 
$$
$$
E^{N(2,1)}(X^4)=E^{N(0,1)}[(Z+2)^4]=E(Z^4)+4E(Z^3)+6E(Z^2)+4E(Z)+16=3+0+6+0+16=25.
$$
We have 
$$g(x) = \frac{1}{25\sqrt{2\pi}} x^4 \exp(-\frac{(x-2)^2}{2}).$$
Since $2x-5 \leq (x-2)^2$, we can write $\exp(-\frac{(x-2)^2}{2}) \leq \exp(-\frac{2x-5}{2})$ and $g(x) \leq x^4\exp(-x)$. This inequality suggests we can use rejection sampling method with $Gamma(5,2)$ to generate a sample depend on $g(x)$.


```{r}
g1 <- function(x){
  dgamma(x, shape = 5, scale = 2)
}
rg1 <- function(n){
  rgamma(n, shape = 5, scale = 2)
}


# Importance sampling function

isAppr <- function(n, h, df, g, rg){
  x <- rg(n)
  mean(h(x) * df(x) / g(x))
}

mysummary <- function(nrep, n, h, df, g, rg){
  sim <- replicate(nrep,isAppr(n, h, df, g, rg))
  c(Expection = mean(sim), Variance = var(sim))
}

```

## (c)

```{r}
mysummary(100,1000, h, df, g1, rg1)
mysummary(100,10000, h, df, g1, rg1)
mysummary(100,50000, h, df, g1, rg1)
```

## (d)
The variances of the second method are closer to 0 comparing with those of first method. 




# Exercis 7.5.2

## (a)

One has 
$$
S(T) = S(0)\exp\{(r-\frac{1}{2}\sigma^2)T+ \sigma W(T)\}
$$
where $W(T) = \sqrt{T}Z$ and $Z \sim N(0,1)$.
Function `St` is given below to sample the path of $S(t)$.
```{r}
s0 <- 1
r <- 0.05
n <- 12

St <- function(t,sigma){
  z <- rnorm(1, mean = 0, sd = 1)
  exp((0.05 - sigma^2/2)*t + sigma*sqrt(t)*z)
}
St_rep <- function(nrep, t, sigma){
  replicate(nrep,St(t, sigma))
}
```

## (b)

```{r}
PA <- function(t, sigma, K){
  iT <- seq(0, t, length.out = n)
  SA <- mean(St(iT, sigma))
  SA_p <- ifelse(SA - K > 0, SA - K ,0)
  exp(-0.05*t)*SA_p
}
PA_rep <- function(nrep, t, sigma, K){
  replicate(nrep,PA(t, sigma, K))
}

PE <- function(t, sigma, K){
  St <- St(t, sigma)
  SE_p <- ifelse(St - K > 0, St - K, 0)
  exp(-0.05*t)*SE_p
}
PE_rep <- function(nrep, t, sigma, K){
  replicate(nrep,PE(t, sigma, K))
}

PG <- function(t, sigma, K){
  iT <- seq(0, t, length.out = n)
  SG <- exp(sum(log( St(iT, sigma) )))
  SG_p <- ifelse(SG - K > 0, SG - K, 0)
  exp(-0.05*t)*SG_p
}
PG_rep <- function(nrep, t, sigma, K){
  replicate(nrep,PG(t, sigma, K))
}

```

```{r}
nrep = 5000
sigma = 0.5
t = 1
K = c(1.1, 1.2, 1.3, 1.4, 1.5)

co_PA_St <- sapply(K, 
                   function(K){
                     P_A <- PA_rep(nrep = nrep, t = t, sigma = sigma, K = K)
                     S_t <- replicate(nrep, St(t=t, sigma= sigma))
                     cor(P_A,S_t)
                   }
)
plot(K, co_PA_St, type = "l"
     , ylab = "correlation coefficient", xlab = "K",
     main = "PA and S(T)")

co_PA_PE <- sapply(K, 
                   function(K){
                     P_A <- PA_rep(nrep = nrep, t = t, sigma = sigma, K = K)
                     P_E <- PE_rep(nrep = nrep, t = t, sigma = sigma, K = K)
                     cor(P_A,P_E)
                   }
)
plot(K, co_PA_PE, type = "l"
     , ylab = "correlation coefficient", xlab = "K",
     main = "PA and PE")

co_PA_PG <- sapply(K, 
                   function(K){
                     P_A <- PA_rep(nrep = nrep, t = t, sigma = sigma, K = K)
                     P_G <- PG_rep(nrep = nrep, t = t, sigma = sigma, K = K)
                     cor(P_A,P_G)
                   }
)
plot(K, co_PA_PG, type = "l"
     , ylab = "correlation coefficient", xlab = "K",
     main = "PA and PG")

```

## (c)

```{r}
t <- 1
K <- 1.5
sigma <- c(2:5)/10
nrep <- 5000

co_PA_St <- sapply(sigma, 
                   function(sigma){
                     P_A <- PA_rep(nrep = nrep, t = t, sigma = sigma, K = K)
                     S_t <- replicate(nrep, St(t=t, sigma= sigma))
                     cor(P_A,S_t)
                   }
)
plot(sigma, co_PA_St, type = "l"
     , ylab = "correlation coefficient", xlab = "sigma",
     main = "PA and S(T)")

co_PA_PE <- sapply(sigma, 
                   function(sigma){
                     P_A <- PA_rep(nrep = nrep, t = t, sigma = sigma, K = K)
                     P_E <- PE_rep(nrep = nrep, t = t, sigma = sigma, K = K)
                     cor(P_A,P_E)
                   }
)
plot(sigma, co_PA_PE, type = "l"
     , ylab = "correlation coefficient", xlab = "sigma",
     main = "PA and PE")

co_PA_PG <- sapply(sigma, 
                   function(sigma){
                     P_A <- PA_rep(nrep = nrep, t = t, sigma = sigma, K = K)
                     P_G <- PG_rep(nrep = nrep, t = t, sigma = sigma, K = K)
                     cor(P_A,P_G)
                   }
)
plot(sigma, co_PA_PG, type = "l"
     , ylab = "correlation coefficient", xlab = "sigma",
     main = "PA and PG")


```

## (d)

```{r}
t <- c(0.4,0.7,1,1.3,1.6)
K <- 1.5
sigma <- 0.5
nrep <- 5000

co_PA_St <- sapply(t, 
                   function(t){
                     P_A <- PA_rep(nrep = nrep, t = t, sigma = sigma, K = K)
                     S_t <- replicate(nrep, St(t=t, sigma= sigma))
                     cor(P_A,S_t)
                   }
)
plot(t, co_PA_St, type = "l"
     , ylab = "correlation coefficient", xlab = "T",
     main = "PA and S(T)")

co_PA_PE <- sapply(t, 
                   function(t){
                     P_A <- PA_rep(nrep = nrep, t = t, sigma = sigma, K = K)
                     P_E <- PE_rep(nrep = nrep, t = t, sigma = sigma, K = K)
                     cor(P_A,P_E)
                   }
)
plot(t, co_PA_PE, type = "l"
     , ylab = "correlation coefficient", xlab = "T",
     main = "PA and PE")

co_PA_PG <- sapply(t, 
                   function(t){
                     P_A <- PA_rep(nrep = nrep, t = t, sigma = sigma, K = K)
                     P_G <- PG_rep(nrep = nrep, t = t, sigma = sigma, K = K)
                     cor(P_A,P_G)
                   }
)
plot(t, co_PA_PG, type = "l"
     , ylab = "correlation coefficient", xlab = "T",
     main = "PA and PG")

```

## (e)

```{r}
sigma <- 0.4
t <- 1
K <- 1.5

P_A <- PA_rep(nrep = 1000, t = t, sigma = sigma, K = K)

PA_control <- function(nrep, t, sigma, K, P_A){
  theta <- PG_rep(nrep = nrep, t = t, sigma = sigma, K = K)
  theta_h <- mean(theta)
  theta_true <- PG(t = t, sigma = sigma, K = K)
  b <- cov(P_A,theta)/var(theta)
  mean(P_A) - b * (theta_h - theta_true)
}

PA_control_rep <- function(nrep1, nrep2, t, sigma, K, P_A){
  replicate(nrep1, PA_control(nrep = nrep2, t=t, sigma = sigma
                              , K = K, P_A = P_A ))
}

P_A_control <- PA_control_rep(1000, 1000, t, sigma, K, P_A )

data.frame("SD without control" = sd(P_A),
           "SD with contorl" = sd(P_A_control))
```

The MC estimator with control variate has a smaller standard error.